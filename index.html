<!DOCTYPE html>
<html>
<head>
    <title>Mars Crypto Conflict</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="telegram-web-app-theme-color" content="#8B4513">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #0a0a1a;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        /* –ö–û–ú–ü–ê–ö–¢–ù–ê–Ø –ò–ì–†–û–í–ê–Ø –°–ï–¢–ö–ê */
        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ - –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
        #top-panel {
            background: rgba(20, 15, 10, 0.95);
            border-bottom: 3px solid #8B4513;
            padding: 8px 12px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
            z-index: 10;
        }
        
        .stat-compact {
            text-align: center;
            padding: 6px;
            background: rgba(139, 69, 19, 0.3);
            border-radius: 6px;
            border: 1px solid #D2691E;
        }
        
        .stat-label {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: bold;
            color: gold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ */
        #main-content {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï (70%) */
        #mars-surface {
            flex: 7;
            background: linear-gradient(135deg, #8B4513, #A0522D, #D2691E);
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }
        
        /* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (30%) */
        #right-panel {
            flex: 3;
            background: rgba(20, 15, 10, 0.95);
            border-left: 3px solid #8B4513;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            max-width: 300px;
        }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–† –ö–ù–û–ü–û–ö –ë–ï–ó –ü–†–û–ö–†–£–¢–ö–ò */
        #buttons-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
            min-height: 0;
        }
        
        /* –ö–ù–û–ü–ö–ò –ü–û–°–¢–†–û–ô–ö–ò */
        .building-btn-compact {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            margin: 4px 0;
            font-size: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .building-btn-compact:hover {
            background: linear-gradient(135deg, #A0522D, #D2691E);
            transform: translateX(2px);
        }
        
        .building-btn-compact:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .building-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .building-info {
            flex: 1;
            min-width: 0;
        }
        
        .building-title {
            font-weight: bold;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .building-desc {
            font-size: 9px;
            color: #ccc;
            margin-top: 2px;
        }
        
        /* –ö–ù–û–ü–ö–ê –°–ë–û–†–ê */
        .collect-btn {
            background: linear-gradient(135deg, #2E8B57, #3CB371);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .collect-btn:hover {
            background: linear-gradient(135deg, #3CB371, #66CDAA);
            transform: scale(1.02);
        }
        
        /* –°–ü–ò–°–û–ö –ó–î–ê–ù–ò–ô */
        #buildings-section {
            flex-shrink: 0;
            padding: 10px;
            border-top: 2px solid #8B4513;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .buildings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .buildings-count {
            background: #8B4513;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .building-item-compact {
            background: rgba(70, 130, 180, 0.2);
            padding: 6px;
            margin: 4px 0;
            border-radius: 5px;
            border-left: 3px solid #467CBE;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .building-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .building-status.active { background: #00FF00; }
        .building-status.inactive { background: #FF5555; }
        .building-status.power { background: gold; }
        
        /* –ó–î–ê–ù–ò–Ø –ù–ê –ö–ê–†–¢–ï */
        .building {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 2px solid white;
            border-radius: 6px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .building:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 0 10px white;
        }
        
        .building.base { background: rgba(70, 130, 180, 0.9); }
        .building.mining { background: rgba(139, 69, 19, 0.9); }
        .building.power { background: rgba(255, 215, 0, 0.9); }
        
        .building-level {
            position: absolute;
            top: -6px;
            right: -6px;
            background: gold;
            color: black;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            border: 1px solid white;
        }
        
        /* –ö–ê–ú–ù–ò */
        .rock {
            position: absolute;
            background: #696969;
            border-radius: 50%;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        
        /* TELEGRAM HEADER */
        #tg-header {
            background: rgba(139, 69, 19, 0.8);
            padding: 6px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .tg-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tg-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid gold;
        }
        
        .tg-name {
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .tg-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        /* –°–û–û–ë–©–ï–ù–ò–Ø */
        #message {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            display: none;
            max-width: 90%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .message-success { border: 2px solid #00FF00; }
        .message-error { border: 2px solid #FF5555; }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• */
        @media (max-width: 768px) {
            #main-content {
                flex-direction: column;
            }
            
            #mars-surface {
                flex: 6;
            }
            
            #right-panel {
                flex: 4;
                max-width: 100%;
                border-left: none;
                border-top: 3px solid #8B4513;
            }
            
            #top-panel {
                grid-template-columns: repeat(2, 1fr);
                padding: 6px 8px;
            }
            
            .tg-name {
                max-width: 100px;
            }
        }
        
        /* –°–ö–†–û–õ–õ–ë–ê–† */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8B4513;
            border-radius: 2px;
        }
        
        /* TELEGRAM AUTH (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        #tg-auth-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            z-index: 2000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- TELEGRAM HEADER -->
    <div id="tg-header" style="display: none;">
        <div class="tg-user">
            <img id="tg-avatar" src="" class="tg-avatar" alt="Avatar">
            <div class="tg-name" id="tg-name">–ò–≥—Ä–æ–∫</div>
        </div>
        <button class="tg-menu-btn" onclick="showTelegramMenu()">‚ãØ</button>
    </div>
    
    <!-- –û–°–ù–û–í–ù–û–ô –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="game-container">
        <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
        <div id="top-panel">
            <div class="stat-compact">
                <div class="stat-label">–ë–∞–ª–∞–Ω—Å</div>
                <div class="stat-value" id="balance">500.00 MNRT</div>
            </div>
            <div class="stat-compact">
                <div class="stat-label">–î–æ–±—ã—Ç–æ</div>
                <div class="stat-value" id="mined">0.0000 MNRT</div>
            </div>
            <div class="stat-compact">
                <div class="stat-label">–≠–Ω–µ—Ä–≥–∏—è</div>
                <div class="stat-value" id="energy">0/0 ‚ö°</div>
            </div>
            <div class="stat-compact">
                <div class="stat-label">–ó–¥–∞–Ω–∏—è</div>
                <div class="stat-value" id="building-count">0 —à—Ç</div>
            </div>
        </div>
        
        <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
        <div id="main-content">
            <!-- –ò–ì–†–û–í–û–ï –ü–û–õ–ï -->
            <div id="mars-surface"></div>
            
            <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
            <div id="right-panel">
                <div id="buttons-container">
                    <button class="building-btn-compact" onclick="startBuilding('base')" id="btn-base">
                        <div class="building-icon">üè†</div>
                        <div class="building-info">
                            <div class="building-title">–ë–∞–∑–∞</div>
                            <div class="building-desc">100 MNRT ‚Ä¢ –û—Å–Ω–æ–≤–∞ –∫–æ–ª–æ–Ω–∏–∏</div>
                        </div>
                    </button>
                    
                    <button class="building-btn-compact" onclick="startBuilding('mining')" id="btn-mining">
                        <div class="building-icon">‚õèÔ∏è</div>
                        <div class="building-info">
                            <div class="building-title">–ë—É—Ä–æ–≤–∞—è</div>
                            <div class="building-desc">200 MNRT ‚Ä¢ 0.001/—Å–µ–∫ ‚Ä¢ 2‚ö°</div>
                        </div>
                    </button>
                    
                    <button class="building-btn-compact" onclick="startBuilding('power')" id="btn-power">
                        <div class="building-icon">‚ö°</div>
                        <div class="building-info">
                            <div class="building-title">–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è</div>
                            <div class="building-desc">200 MNRT ‚Ä¢ +5‚ö° —ç–Ω–µ—Ä–≥–∏–∏</div>
                        </div>
                    </button>
                    
                    <button class="collect-btn" onclick="collectResources()">
                        <span>üí∞</span>
                        <span>–°–æ–±—Ä–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã</span>
                    </button>
                </div>
                
                <!-- –°–ü–ò–°–û–ö –ü–û–°–¢–†–û–ï–ù–ù–´–• –ó–î–ê–ù–ò–ô -->
                <div id="buildings-section">
                    <div class="buildings-header">
                        <h4 style="font-size: 12px;">üèóÔ∏è –ú–æ–∏ –∑–¥–∞–Ω–∏—è</h4>
                        <div class="buildings-count" id="buildings-count">0</div>
                    </div>
                    <div id="buildings-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
    <div id="message"></div>
    
    <!-- TELEGRAM AUTH PANEL -->
    <div id="tg-auth-panel">
        <div style="font-size: 48px; margin-bottom: 15px;">üöÄ</div>
        <h1 style="color: #FF4500; margin-bottom: 10px; font-size: 24px;">Mars Crypto Conflict</h1>
        <p style="color: #ccc; margin-bottom: 25px; max-width: 300px; font-size: 14px;">
            –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω–µ BSC
        </p>
        
        <button onclick="launchInTelegram()" style="
            background: linear-gradient(135deg, #0088cc, #00aced);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        ">
            ‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å –≤ Telegram
        </button>
        
        <div style="margin-top: 20px; font-size: 13px; color: #888;">
            –ë–æ—Ç: @MarsCC_Bot
        </div>
    </div>

    <!-- TELEGRAM SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
        // ============================
        // –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
        // ============================
        let TelegramWebApp = null;
        let tgUser = null;
        let isTelegram = false;
        
        function detectTelegram() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    TelegramWebApp = window.Telegram.WebApp;
                    isTelegram = true;
                    
                    TelegramWebApp.ready();
                    TelegramWebApp.expand();
                    TelegramWebApp.setHeaderColor('#8B4513');
                    TelegramWebApp.setBackgroundColor('#0a0a1a');
                    
                    if (TelegramWebApp.initDataUnsafe?.user) {
                        tgUser = TelegramWebApp.initDataUnsafe.user;
                        showTelegramUser();
                    }
                    
                    setupTelegramButtons();
                    hideAuthPanel();
                    showGame();
                    initGame();
                    
                    return true;
                }
            } catch (error) {
                console.log('Not in Telegram');
            }
            return false;
        }
        
        function showTelegramUser() {
            if (!tgUser) return;
            
            document.getElementById('tg-header').style.display = 'flex';
            
            if (tgUser.photo_url) {
                document.getElementById('tg-avatar').src = tgUser.photo_url;
            }
            
            let name = tgUser.first_name || '–ò–≥—Ä–æ–∫';
            if (tgUser.username) {
                name += ' (@' + tgUser.username + ')';
            }
            document.getElementById('tg-name').textContent = name;
        }
        
        function hideAuthPanel() {
            document.getElementById('tg-auth-panel').style.display = 'none';
        }
        
        function showGame() {
            document.getElementById('game-container').style.display = 'flex';
        }
        
        function launchInTelegram() {
            const botUsername = 'MarsCC_Bot';
            const gameUrl = window.location.href;
            const telegramUrl = `https://t.me/${botUsername}?startapp=${encodeURIComponent(gameUrl)}`;
            
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.openLink(telegramUrl);
            } else {
                window.open(telegramUrl, '_blank');
            }
        }
        
        function setupTelegramButtons() {
            if (!TelegramWebApp) return;
            
            TelegramWebApp.MainButton.setText('–ü—Ä–æ—Ñ–∏–ª—å');
            TelegramWebApp.MainButton.onClick(showProfile);
            TelegramWebApp.MainButton.show();
        }
        
        function showTelegramMenu() {
            if (!TelegramWebApp) return;
            
            TelegramWebApp.showPopup({
                title: '–ú–µ–Ω—é',
                message: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
                buttons: [
                    {id: 'profile', type: 'default', text: 'üìä –ü—Ä–æ—Ñ–∏–ª—å'},
                    {id: 'share', type: 'default', text: 'üì¢ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å'},
                    {type: 'cancel'}
                ]
            }, function(buttonId) {
                if (buttonId === 'profile') showProfile();
                if (buttonId === 'share') shareGame();
            });
        }
        
        function showProfile() {
            if (!tgUser) return;
            showMessage(`üë§ ${tgUser.first_name}\nID: ${tgUser.id}\n–ë–∞–ª–∞–Ω—Å: ${gameState.balance.toFixed(2)} MNRT`, 'success');
        }
        
        function shareGame() {
            const botUsername = 'MarsCC_Bot';
            const shareText = `üöÄ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ Mars Crypto Conflict!`;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(`https://t.me/${botUsername}`)}&text=${encodeURIComponent(shareText)}`;
            
            if (isTelegram && TelegramWebApp) {
                TelegramWebApp.openLink(shareUrl);
            } else {
                window.open(shareUrl, '_blank');
            }
        }
        
        // ============================
        // –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
        // ============================
        const CONFIG = {
            MINING_RATE: 0.001,
            TOTAL_SUPPLY: 5000000000,
            BUILDING_COSTS: { base: 100, mining: 200, power: 200 },
            ENERGY_CONSUMPTION: { base: 0, mining: 2, power: 0 },
            ENERGY_PRODUCTION: { base: 0, mining: 0, power: 5 },
            UPKEEP_COSTS: { base: 0.0002, mining: 0.0002, power: 0.0002 }
        };

        let gameState = {
            balance: 500.0,
            mined: 0.0,
            supply: CONFIG.TOTAL_SUPPLY,
            totalMinedAllTime: 0.0,
            buildings: [],
            placingBuilding: null,
            nextId: 1,
            hasBase: false,
            energy: { production: 0, consumption: 0 },
            upkeepDebt: 0,
            lastUpdate: Date.now()
        };

        function generateMarsSurface() {
            const surface = document.getElementById('mars-surface');
            surface.innerHTML = '';
            
            for (let i = 0; i < 30; i++) {
                const rock = document.createElement('div');
                rock.className = 'rock';
                rock.style.width = Math.random() * 30 + 15 + 'px';
                rock.style.height = Math.random() * 30 + 15 + 'px';
                rock.style.left = Math.random() * 95 + '%';
                rock.style.top = Math.random() * 95 + '%';
                rock.style.background = `rgb(${80 + Math.random() * 40}, ${80 + Math.random() * 40}, ${80 + Math.random() * 40})`;
                surface.appendChild(rock);
            }
            
            renderBuildings();
        }

        function createBuildingElement(building) {
            const div = document.createElement('div');
            div.className = `building ${building.type}`;
            div.id = `building-${building.id}`;
            div.style.left = building.x + 'px';
            div.style.top = building.y + 'px';
            
            const icon = document.createElement('div');
            icon.textContent = building.type === 'base' ? 'üè†' : building.type === 'mining' ? '‚õèÔ∏è' : '‚ö°';
            div.appendChild(icon);
            
            if (building.level > 0) {
                const level = document.createElement('div');
                level.className = 'building-level';
                level.textContent = building.level;
                div.appendChild(level);
            }
            
            return div;
        }

        function renderBuildings() {
            const surface = document.getElementById('mars-surface');
            document.querySelectorAll('.building').forEach(el => el.remove());
            
            gameState.buildings.forEach(building => {
                const buildingEl = createBuildingElement(building);
                surface.appendChild(buildingEl);
                
                buildingEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showMessage(`${getBuildingName(building.type)} #${building.id}`, 'success');
                });
            });
        }

        function startBuilding(type) {
            const cost = CONFIG.BUILDING_COSTS[type];
            
            if (gameState.balance < cost) {
                showMessage(`‚ùå –ù—É–∂–Ω–æ ${cost} MNRT`, 'error');
                return;
            }
            
            if ((type === 'mining' || type === 'power') && !gameState.hasBase) {
                showMessage('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –±–∞–∑—É', 'error');
                return;
            }
            
            gameState.placingBuilding = type;
            showMessage(`üèóÔ∏è –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`, 'success');
        }

        document.getElementById('mars-surface').addEventListener('click', function(e) {
            if (!gameState.placingBuilding) return;
            
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            for (const building of gameState.buildings) {
                const distance = Math.sqrt(Math.pow(x - building.x, 2) + Math.pow(y - building.y, 2));
                if (distance < 70) {
                    showMessage('‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ', 'error');
                    return;
                }
            }
            
            const cost = CONFIG.BUILDING_COSTS[gameState.placingBuilding];
            gameState.balance -= cost;
            
            const building = {
                id: gameState.nextId++,
                type: gameState.placingBuilding,
                x: x,
                y: y,
                level: 0,
                hasPower: true
            };
            
            gameState.buildings.push(building);
            
            if (gameState.placingBuilding === 'base') {
                gameState.hasBase = true;
            }
            
            gameState.placingBuilding = null;
            updateUI();
            renderBuildings();
            
            showMessage(`‚úÖ ${getBuildingName(building.type)} –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞`, 'success');
        });

        function collectResources() {
            if (gameState.mined > 0) {
                const collected = gameState.mined;
                gameState.balance += collected;
                gameState.totalMinedAllTime += collected;
                gameState.mined = 0;
                showMessage(`üí∞ +${collected.toFixed(4)} MNRT`, 'success');
                updateUI();
            } else {
                showMessage('‚õèÔ∏è –ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤', 'error');
            }
        }

        function calculateEnergy() {
            let production = 0;
            let consumption = 0;
            
            gameState.buildings.forEach(building => {
                production += CONFIG.ENERGY_PRODUCTION[building.type] || 0;
                consumption += CONFIG.ENERGY_CONSUMPTION[building.type] || 0;
            });
            
            gameState.buildings.forEach(building => {
                if (building.type === 'mining') {
                    building.hasPower = (production >= consumption);
                }
            });
            
            gameState.energy = { production, consumption };
            return { production, consumption };
        }

        function updateMining() {
            const now = Date.now();
            const elapsedSeconds = (now - gameState.lastUpdate) / 1000;
            gameState.lastUpdate = now;
            
            const energy = calculateEnergy();
            const upkeepPerSecond = calculateUpkeep();
            const totalUpkeep = upkeepPerSecond * elapsedSeconds;
            
            const activeMiningBuildings = gameState.buildings.filter(b => 
                b.type === 'mining' && b.hasPower
            );
            
            if (activeMiningBuildings.length === 0) {
                if (gameState.mined > 0) {
                    const upkeepFromMined = Math.min(totalUpkeep, gameState.mined);
                    gameState.mined -= upkeepFromMined;
                    gameState.upkeepDebt += totalUpkeep - upkeepFromMined;
                } else {
                    gameState.upkeepDebt += totalUpkeep;
                }
                updateUI();
                return;
            }
            
            let totalMining = 0;
            activeMiningBuildings.forEach(building => {
                const multiplier = 1 + (building.level * 0.2);
                totalMining += CONFIG.MINING_RATE * multiplier;
            });
            
            const netMiningPerSecond = totalMining - upkeepPerSecond;
            
            if (netMiningPerSecond > 0) {
                const minedThisTick = netMiningPerSecond * elapsedSeconds;
                if (gameState.supply >= minedThisTick) {
                    gameState.mined += minedThisTick;
                    gameState.supply -= minedThisTick;
                }
            }
            
            updateUI();
        }

        function calculateUpkeep() {
            let totalUpkeep = 0;
            gameState.buildings.forEach(building => {
                totalUpkeep += CONFIG.UPKEEP_COSTS[building.type] || 0;
            });
            return totalUpkeep;
        }

        function getBuildingName(type) {
            const names = { base: '–ë–∞–∑–∞', mining: '–ë—É—Ä–æ–≤–∞—è', power: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è' };
            return names[type] || type;
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message-${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 2000);
        }

        function updateUI() {
            // –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–ò–°–¢–ò–ö–£
            document.getElementById('balance').textContent = gameState.balance.toFixed(2) + ' MNRT';
            document.getElementById('mined').textContent = gameState.mined.toFixed(4) + ' MNRT';
            
            const energy = calculateEnergy();
            document.getElementById('energy').textContent = `${energy.production}/${energy.consumption} ‚ö°`;
            document.getElementById('energy').style.color = energy.production >= energy.consumption ? '#00FF00' : '#FF5555';
            
            document.getElementById('building-count').textContent = gameState.buildings.length + ' —à—Ç';
            document.getElementById('buildings-count').textContent = gameState.buildings.length;
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –ö–ù–û–ü–ö–ò
            document.getElementById('btn-base').disabled = gameState.balance < 100;
            document.getElementById('btn-mining').disabled = gameState.balance < 200 || !gameState.hasBase;
            document.getElementById('btn-power').disabled = gameState.balance < 200 || !gameState.hasBase;
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –°–ü–ò–°–û–ö –ó–î–ê–ù–ò–ô
            updateBuildingsList();
        }

        function updateBuildingsList() {
            const container = document.getElementById('buildings-container');
            container.innerHTML = '';
            
            if (gameState.buildings.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center; padding: 10px; font-size: 10px;">–ù–µ—Ç –∑–¥–∞–Ω–∏–π</div>';
                return;
            }
            
            gameState.buildings.forEach(building => {
                const div = document.createElement('div');
                div.className = 'building-item-compact';
                
                let statusClass = 'active';
                if (building.type === 'mining') {
                    statusClass = building.hasPower ? 'active' : 'inactive';
                } else if (building.type === 'power') {
                    statusClass = 'power';
                }
                
                div.innerHTML = `
                    <div class="building-status ${statusClass}"></div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: bold; font-size: 9px;">${getBuildingName(building.type)} #${building.id}</div>
                        <div style="font-size: 8px; color: #aaa;">–£—Ä. ${building.level + 1} | ${building.type === 'mining' ? (building.hasPower ? 'üü¢' : 'üî¥') : ''}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function initGame() {
            generateMarsSurface();
            updateUI();
            gameState.lastUpdate = Date.now();
            setInterval(updateMining, 1000);
        }

        // –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        window.onload = function() {
            if (!detectTelegram()) {
                document.getElementById('tg-auth-panel').style.display = 'flex';
            }
        };
    </script>
</body>
</html>
